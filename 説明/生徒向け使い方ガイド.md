# M5Stack-BME280-ESPNOW 生徒向け使い方ガイド

このガイドは、**Arduinoを触ったことがない人**向けに、lesson1からlesson7までの学習用コードの使い方を詳しく説明します。

## 📚 目次

1. [Arduino IDEの基本操作](#arduino-ideの基本操作)
2. [必要な環境の準備](#必要な環境の準備)
3. [センサーと通信方式について](#センサーと通信方式について)
4. [lesson1: センサーを使う](#lesson1-センサーを使う)
5. [lesson2: マイコンのUI作成](#lesson2-マイコンのui作成)
6. [lesson3: 無線通信をする（ESP-NOW）](#lesson3-無線通信をするesp-now)
7. [lesson4: マイコンのUI作成（M5Stack側）](#lesson4-マイコンのui作成m5stack側)
8. [lesson5: PCとの接続（Python）](#lesson5-pcとの接続python)
9. [lesson6: PythonでUIを作成](#lesson6-pythonでuiを作成)
10. [lesson7: 参加者で共同作品](#lesson7-参加者で共同作品)
11. [よくあるエラーと解決方法](#よくあるエラーと解決方法)

---

## Arduino IDEの基本操作

### Arduino IDEとは？

**Arduino IDE**は、ArduinoやESP32などのマイコンにプログラムを書き込むためのソフトウェアです。無料でダウンロードできます。

### 基本的な用語

- **スケッチ（Sketch）**: Arduinoのプログラムファイルのこと
- **コンパイル（Compile）**: プログラムをマイコンが理解できる形式に変換すること
- **アップロード（Upload）**: コンパイルしたプログラムをマイコンに書き込むこと
- **シリアルモニター**: マイコンとPCの間でデータをやり取りするための画面

### Arduino IDEの画面構成
Arduino IDEを開くと、以下のような画面が表示されます：
![[arduino_ide_screen.png]]
  - メニューバー（ファイル、編集、スケッチ、ツールなど）
  - コードエディタ（中央の白い部分）
  - ツールバー（コンパイル、アップロードボタン）
  - メッセージエリア（下部の黒い部分）

### 基本的な操作

1. **ファイルを開く**: `ファイル > 開く` または `Ctrl+O`（Windows）/ `Cmd+O`（Mac）
2. **コンパイル**: `スケッチ > 検証/コンパイル` または `Ctrl+R`（Windows）/ `Cmd+R`（Mac）
3. **アップロード**: `スケッチ > アップロード` または `Ctrl+U`（Windows）/ `Cmd+U`（Mac）
4. **シリアルモニターを開く**: `ツール > シリアルモニター` または `Ctrl+Shift+M`（Windows）/ `Cmd+Shift+M`（Mac）

---

## 必要な環境の準備

### ハードウェア

- **M5StickC Plus**（lesson1-3, lesson7用）
- **M5Stack**（lesson4-5用）
- **BME280センサー**（I2C接続）
- **USBケーブル**（データ転送対応のもの）
- ![[Pasted image 20260115151755.png]]


### ソフトウェア

#### 1. Arduino IDEのインストール

1. [Arduino IDE公式サイト](https://www.arduino.cc/en/software)からダウンロード
2. インストーラーを実行してインストール
3. Arduino IDEを起動

![[Pasted image 20260110220847.png]]

#### 2. ESP32ボードの追加

Arduino IDEには最初からESP32の設定が入っていないので、追加する必要があります。

**ステップ1: 環境設定を開く**

1. Arduino IDEを開く
2. **ファイル > 基本設定クリック

![[Pasted image 20260109224047.png]]
- 説明: Arduino IDEの環境設定画面
- 「追加のボードマネージャーのURL」の欄が表示されている

**ステップ2: ボードマネージャーのURLを追加**
![[Pasted image 20260109224431.png]]
3. **矢印の箇所をクリックして追加のボードマネージャーのURL**の欄に以下を追加：
https://static-cdn.m5stack.com/resource/arduino/package_m5stack_index.json 
https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

4. **OK**をクリック

**ステップ3: ボードマネージャーを開く**
![[Pasted image 20260109224859.png]]
5. **ツール > ボード > ボードマネージャー**を開く


**ステップ4: ESP32とM5stackをインストール**

6. 検索欄に「**ESP32**」と入力
7. 「**esp32 by Espressif Systems**」を探して、**バージョン2.0.1**(最新バージョンでないので注意)を選択して**インストール**をクリック
8. インストールが完了するまで待つ（数分かかります）
9. 検索欄に「**M5stack**」と入力
10. 「M5stack」を探して,バージョンを3.2.5を選択してインストールをクリック
11. インストールが完了するまで待つ（数分かかります）
![[Pasted image 20260115153629.png]]
#### 3. ライブラリのインストール

以下のライブラリをインストールします：

1. **ツール > ライブラリを管理**を開く

![[Pasted image 20260109225324.png]]

2. 検索欄にライブラリ名を入力して、それぞれインストール：

   **M5StickCPlus**（M5StickC Plus用）
   - 検索: 「M5StickCPlus」
   - 「M5StickCPlus by M5Stack」バージョン0.1.1をインストール
   - InstallAllを選択

   **M5Stack**（M5Stack用）
   - 検索: 「M5Stack」
   - 「M5Stack by M5Stack」バージョン0.4.6をインストール

   **Adafruit BME280 Library**
   - 検索: 「BME280」
   - 「Adafruit BME280 Library by Adafruit」バージョン2.3.0をインストール
####4.USBドライバのインストール
1.https://docs.m5stack.com/en/download このサイトからCP210x_VCP_Windows をダウンロードして展開
2.CP210xVCPInstaller_x64_v6.7.0.0.exeというファイルを実行してドライバーのインストール

#### 5. Python環境の準備（lesson5-7用）

1. [Python公式サイト](https://www.python.org/downloads/)からPython 3.7以上をダウンロード・インストール
2. コマンドプロンプト（Windows）またはターミナル（Mac）を開く
3. 以下のコマンドを実行してライブラリをインストール：
   ```bash
   pip install pyserial matplotlib numpy scipy
   ```

---

## センサーと通信方式について

このセクションでは、このプロジェクトで使用するセンサーと通信方式について説明します。初心者の方でも理解できるよう、専門用語を避けてわかりやすく説明します。

### BME280センサーとは？

**BME280**は、温度・湿度・気圧を同時に測定できる環境センサーです。
BME280かなり有名なセンサーでいろんなボードがあります。
![[Pasted image 20260109230217.png]]
複数あるってことは、BME280にも種類がいくつかあるってこと？

いいえ、BME280センサはどこのメーカーも同じものを使っています。
ボードは複数あるけど、使っているセンサーはみな一緒（下のやつがBME280）
![[Pasted image 20260109230314.png]]
参考：BME280データシート

[https://raw.githubusercontent.com/SeeedDocument/Grove-Barometer_Sensor-BME280/master/res/Grove-Barometer_Sensor-BME280-.pdf](https://raw.githubusercontent.com/SeeedDocument/Grove-Barometer_Sensor-BME280/master/res/Grove-Barometer_Sensor-BME280-.pdf)
#### 測定できるもの

- **温度（Temperature）**: 周囲の温度を摂氏（°C）で測定します
  - 例: 25.30°C（室温程度）
- **湿度（Humidity）**: 空気中の水分量をパーセント（%RH）で測定します
  - 例: 55.20%RH（快適な湿度）
- **気圧（Pressure）**: 大気圧をヘクトパスカル（hPa）で測定します
  - 例: 1013.25hPa（標準的な気圧）

#### なぜBME280を使うの？

- **1つのセンサーで3つのデータ**が取得できるため、配線が簡単です
- **精度が高い**ため、正確な測定ができます
- **小型で安価**なため、学習用に最適です


### I2C通信とは？

**I2C（アイ・スクエア・シー）**は、センサーとマイコンを接続するための通信方式です。

#### なぜI2Cを使うの？

- **配線が少ない**: データ線（SDA）とクロック線（SCL）の2本だけで複数のセンサーと接続できます
- **簡単**: 複雑な設定が不要で、初心者でも扱いやすいです
- **標準的**: 多くのセンサーがI2Cに対応しています

#### I2Cの接続方法

BME280とM5StickC Plusを接続する場合：

```
BME280          M5StickC Plus
─────────────────────────────
VCC  ──────────> 3.3V（電源）
GND  ──────────> GND（接地）
SDA  ──────────> GPIO 32（データ線）
SCL  ──────────> GPIO 33（クロック線）
```

![[Pasted image 20260109230406.png]]

#### I2Cアドレスとは？

I2Cで接続されたセンサーには、それぞれ**アドレス**（番地のようなもの）が割り当てられています。

- BME280のデフォルトアドレス: **0x76**（16進数）
- もし0x76で見つからない場合は、**0x77**を試してみてください

コードでは以下のように指定します：
```c
bme.begin(0x76, &Wire);  // 0x76はI2Cアドレス
```

### ESP-NOW通信とは？

**ESP-NOW**は、ESP32マイコン専用の無線通信プロトコルです。

#### なぜESP-NOWを使うの？

- **Wi-Fi不要**: ルーターやアクセスポイントがなくても通信できます
- **低消費電力**: Wi-Fiより省エネで、バッテリー駆動に適しています
- **高速**: データの送受信が速いです
- **簡単**: 複雑な設定が不要で、コードがシンプルです

#### ESP-NOWの仕組み

1. **送信側（M5StickC Plus）**: センサーデータを取得して、無線で送信します
2. **受信側（M5Stack）**: 送信されたデータを受信して、シリアルポートに出力します

#### 通信に必要な設定

- **チャンネル（CHANNEL）**: 無線の周波数帯域。送信側と受信側で**同じチャンネル**に設定する必要があります
  - 例: `CHANNEL = 1`
- **MACアドレス**: 各デバイスに割り当てられた固有の識別番号これで通信するデバイスを指定します。デバイスの名前のようなものです。
  - 例: `98:f4:ab:6c:e7:88`
  - 送信側は、受信側のMACアドレスを指定する必要があります


### シリアル(UART)通信とは？

**シリアル通信**は、マイコンとPCの間でデータをやり取りする方法です。

#### なぜシリアル通信を使うの？

- **デバッグに便利**: プログラムの動作を確認できます
- **データ取得**: センサーデータをPCで処理できます
- **標準的**: ほとんどのマイコンが対応しています

#### シリアル通信の設定

- **ボーレート（Baud Rate）**: データの送信速度
  - このプロジェクトでは **115200** を使用します
  - 送信側と受信側で**同じボーレート**に設定する必要があります

#### シリアルモニターとは？

Arduino IDEの**シリアルモニター**は、マイコンから送られてくるデータを表示する画面です。

- マイコンが送信したデータ（文字や数字）がリアルタイムで表示されます
- デバッグやデータ確認に便利です

![[Pasted image 20260114125314.png]]

### 通信方式のまとめ

このプロジェクトでは、以下の3つの通信方式を使用します：

| 通信方式 | 用途 | 使用するレッスン |
|---------|------|-----------------|
| **I2C** | BME280センサーとマイコンの接続 | lesson1-7 |
| **ESP-NOW** | M5StickC PlusとM5Stackの無線通信 | lesson3-7 |
| **シリアル通信** | M5StackとPCのデータ通信 | lesson5-7 |

### よくある質問

**Q: I2CとESP-NOWの違いは？**

A: 
- **I2C**: 有線で、センサーとマイコンを直接接続します（数cm程度の距離）
- **ESP-NOW**: 無線で、マイコン同士を接続します（10-50m程度の距離）

**Q: なぜ複数の通信方式を使うの？**

A: それぞれの通信方式には得意な用途があります：
- I2C: センサーとの接続に最適
- ESP-NOW: 無線通信に最適
- シリアル通信: PCとの接続に最適

**Q: 通信がうまくいかない場合は？**

A: [よくあるエラーと解決方法](#よくあるエラーと解決方法)のセクションを確認してください。

---

## lesson1: センサーを使う

### このレッスンで学ぶこと

M5StickCとBME280センサーを使って、温度・湿度・気圧を計測し、画面に表示します。

### 準備するもの

- M5StickC Plus
- BME280センサー
- USBケーブル

![[84715.jpg]]

### セットアップ手順

#### ステップ1: ファイルを開く

1. Arduino IDEを開く
2. **ファイル > 開く**をクリック
3. プロジェクトフォルダの`Arduino/lesson/lesson1.ino`を選択
4. ファイルが開きます

![[Pasted image 20260109231349.png]]
#### ステップ2: ボードを選択

1. **ツール > ボード**をクリック
2. **M5StickC Plus**を選択
   - もし見つからない場合は、**ESP32 Arduino**の中を探してください

![[Pasted image 20260109231423.png]]

#### ステップ3: シリアルポートを選択

1. M5StickC PlusをUSBケーブルでPCに接続
2. **ツール > シリアルポート**をクリック
3. 表示されたポートを選択
   - Windowsの場合: `COM3`、`COM5`など
   - Macの場合: `/dev/cu.usbserial-xxxx`など
   - 複数ある場合は、接続したばかりのものを選択
![[Pasted image 20260109231457.png]]



#### ステップ4: コンパイルとアップロード

1. **スケッチ > 検証/コンパイル**をクリック（または`Ctrl+R`/`Cmd+R`）
   - 画面下部に「コンパイルが完了しました」と表示されればOK
   - エラーが出た場合は、[よくあるエラーと解決方法](#よくあるエラーと解決方法)を確認してください

#### ステップ5: 動作確認

1. M5StickC Plusの画面を確認
2. 温度・湿度・気圧が表示されていれば成功です！
3. 1秒ごとに値が更新されます
**作成結果**
![[Pasted image 20260109232636.png]]

### 参加者ミッション

自分の割り当てられた番号も画面に表示できるように変更してください。

**ヒント**: 
- コードの中に`M5.Lcd.println("Env Measure");`という行があります
- この下に自分のデバイスIDを表示する行を追加してみましょう
- 例: `M5.Lcd.printf("No: %s\n", DEVICE_ID);`（5を自分の番号に変更）


---

## lesson2: マイコンのUI作成

### このレッスンで学ぶこと

lesson1をベースに、BME280から取得したデータをグラフで表示します。

### 準備するもの
- M5StickC Plus
- BME280センサー
- USBケーブル

### セットアップ手順

1. **ファイル > 開く**で`Arduino/lesson/lesson2.ino`を開く
2. lesson1と同じように、**ボード**と**シリアルポート**を選択
3. **コンパイル**して、**アップロード**
4. M5StickCの画面に温度のグラフが表示されます

### 動作確認

- 画面の上部に温度・湿度・気圧の数値が表示されます
- 画面の下部に温度のグラフが表示されます
- グラフは過去20個のデータポイントを表示します

![[84723.jpg]]

### 参加者ミッション

最初は温度のグラフが表示されます。気圧や湿度のグラフを表示できるように変更してください。

**ヒント**: 
1. コードの最後の方（`loop()`関数内）を探してください
2. `drawGraph(temp);`という行を見つけてください
3. この行を変更します：
   - 気圧のグラフ: `drawGraph(pres);`
   - 湿度のグラフ: `drawGraph(hum);`
4. 変更したら、コンパイルしてアップロードしてください

**注意**: 変更するときは、`drawGraph(temp);`の`temp`の部分だけを変更してください。`drawGraph();`はそのままにしてください。


---

## lesson3: 無線通信をする（ESP-NOW）

### このレッスンで学ぶこと

M5StickCからM5StackにBME280のデータをESP-NOWという無線通信で送信します。

### 準備するもの
- M5StickC Plus（送信側）
- M5Stack（受信側）
- BME280センサー
- USBケーブル2本

![[Pasted image 20260110000629.png]]

### セットアップ手順

#### パート1: ゲートウェイ（受信側：M5Stack）の設定

1. **ファイル > 開く**で`Arduino/gateway_espnow_serial/gateway_espnow_serial.ino`を開く
2. **ツール > ボード**で「**M5Stack**」を選択
3. **ツール > シリアルポート**でM5Stackのポートを選択
4. **コンパイル**して、**アップロード**
5. **ツール > シリアルモニター**を開く（ボーレート: 115200）
6. シリアルモニターに表示される**MACアドレス**をメモしてください
   - 例: `98:f4:ab:6c:e7:88`
   - このMACアドレスは後で使います

**シリアルモニターでMACアドレス確認**
- シリアルモニターの画面で`{"type":"gateway_boot","channel":1,"mac":"98:f4:ab:6c:e7:88"}`のようなJSONが表示されているので"mac":の後の英数字がmacアドレスです。

#### パート2: 送信側（M5StickC）の設定

1. **ファイル > 開く**で`Arduino/lesson/lesson3.ino`を開く
2. **ツール > ボード**で「**M5StickC Plus**」を選択
3. **ツール > シリアルポート**でM5StickCのポートを選択

4. **コードを変更**します。以下の部分を見つけて変更してください：

   ```c
   // ゲートウェイのMACアドレスを設定
   uint8_t GATEWAY_MAC[6] = {0x98, 0xf4, 0xab, 0x6c, 0xe7, 0x88};  // ← ここを変更
   ```
   
   **変更方法**:
   - パート1でメモしたMACアドレスを確認
   - 例: `98:f4:ab:6c:e7:88`の場合
   - `{0x98, 0xf4, 0xab, 0x6c, 0xe7, 0x88}`に変更
   - `0x`はそのまま、数字の部分だけをMACアドレスに合わせて変更


   ```c
   // デバイスIDを設定
   const char DEVICE_ID[] = "B1";  // ← 自分のIDに変更
   ```
   
   **変更方法**:
   - `"B1"`の部分を自分のIDに変更
   - 例: `"A1"`, `"A2"`, `"B2"`など

5. **コンパイル**して、**アップロード**

#### パート3: 動作確認

1. M5StickCの画面に「ESP-NOW Sender」と表示され、送信状態が表示されます（確認する）
2. M5StackのシリアルモニターにJSON形式のデータが表示されます
   - 例: `{"type":"sample","id":"B1","t":25.30,"h":55.20,"p":1013.25,"seq":123,"from":"98:f4:ab:6c:e7:88"}`

![[84723.jpg]]

![[Pasted image 20260114015402.png]]値あるときに変更
### 参加者ミッション

ESP-NOWの無線通信部分がどこにあるか学習してください。

**確認する場所**:
- `setup()`関数内: `esp_now_init()` - ESP-NOWの初期化
- `loop()`関数内: `esp_now_send()` - データの送信
- `OnDataSent()`関数: 送信完了したときに呼ばれる関数
---

## lesson4: マイコンのUI作成（M5Stack側）

### このレッスンで学ぶこと

M5Stack側でESP-NOWで受信したデータをグラフ表示します。

### 準備するもの

- M5StickC Plus（送信側）
- M5Stack（受信側）
- BME280センサー
- USBケーブル2本

### セットアップ手順

1. lesson3のパート1と同じように、M5Stackに`Arduino/lesson/lesson4.ino`をアップロード
2. lesson3のパート2と同じように、M5StickCに`Arduino/lesson/lesson3.ino`をアップロード(lesson3からの変更はしなくてよいです)

### 動作確認

- M5Stackの画面に温度のグラフが表示されます
- 受信したデータ数や最後に受信したデバイスIDが表示されます

**📷 画像28: lesson4の動作画面**
- ファイル名: `lesson4_result.png`
- 説明: M5Stackの画面
- 上部に受信情報、下部に温度のグラフが表示されている

### 参加者ミッション

最初は温度だけのグラフが表示されます。気圧も湿度も一緒に表示できるように変更してください。

**ヒント**: 
1. `loop()`関数内のグラフ描画部分を探してください
2. 温度のグラフを描画している部分を見つけます：
   ```c
   drawGraphWithLabel(tempHistory, RED, "Temp:", graphYOffset);
   graphYOffset += GRAPH_HEIGHT + 20;
   ```
3. この下に、湿度と気圧のグラフを追加します：
   ```c
   // 湿度のグラフを追加
   drawGraphWithLabel(humHistory, BLUE, "Humidity:", graphYOffset);
   graphYOffset += GRAPH_HEIGHT + 20;
   
   // 気圧のグラフを追加
   drawGraphWithLabel(presHistory, GREEN, "Pressure:", graphYOffset);
   graphYOffset += GRAPH_HEIGHT + 20;
   ```
4. 変更したら、コンパイルしてアップロードしてください


---

## lesson5: PCとの接続（Python）

### このレッスンで学ぶこと

M5StackからPythonにシリアル通信でデータを取得します。

### 準備するもの

- M5StickC Plus（送信側）
- M5Stack（受信側）
- BME280センサー
- USBケーブル2本
- PythonがインストールされたPC

### セットアップ手順

1. lesson3のパート1と同じように、M5Stackに`Arduino/lesson/lesson5.c`をアップロード
2. lesson3のパート2と同じように、M5StickCに`Arduino/lesson/lesson3.c`をアップロード(レッスン3から変更しなくてよいです)
3. M5StackをUSBケーブルでPCに接続
4. シリアルポート番号を確認
   - Windows: デバイスマネージャーで「COM5」など
   - Mac: ターミナルで`ls /dev/tty.*`を実行
![[Pasted image 20260113103324.png]]
上記のツール/シリアルモニタを選択するとシリアル通信をすることができます。
### Pythonでのデータ取得
VSCodeのターミナルで以下のコードを実行してください
   ```bash
   python lesson5.py
   ```
ターミナルを開くと、以下のようなJSON形式のデータが表示されます：
```json
{"type":"sample","id":"B1","t":25.30,"h":55.20,"p":1013.25,"seq":123,"from":"98:f4:ab:6c:e7:88"}
```

画像:Pythonで受信している画像

### 参加者ミッション

シリアル通信について学んでください。COMポートの設定が人によって違うことを学習します。

**確認ポイント**:
- WindowsとmacOS/Linuxでポート名の形式が異なる
  - Windows: `COM5`, `COM7`など
  - Mac/Linux: `/dev/tty.usbserial-xxxx`など
- ボーレート（115200）が一致している必要がある
- 他のアプリケーションがポートを使用していないか確認

---

## lesson6: PythonでUIを作成

### このレッスンで学ぶこと

シリアル通信で取得したデータをPythonでグラフ化します。

### 準備するもの
- M5StickC Plus（送信側）
- M5Stack（受信側）
- BME280センサー
- USBケーブル2本
- PythonがインストールされたPC

### セットアップ手順

1. lesson5と同様に、M5StackをPCに接続
2. コマンドプロンプト（Windows）またはターミナル（Mac）を開く
3. プロジェクトフォルダの`python`フォルダに移動：
   ```bash
   cd python
   ```
4. Pythonスクリプトを実行：
   ```bash
   python lesson6.py --port COM5  # Windowsの場合（COM5を自分のポート番号に変更）
   # または
   python lesson6.py --port /dev/tty.usbserial-xxxx  # macOS/Linuxの場合
   ```



### 動作確認

- Pythonのウィンドウにグラフが表示されます
- リアルタイムでデータが更新されます
- 温度、湿度、気圧の3つのグラフが表示されます

**📷 画像33: lesson6のグラフ表示**
- ファイル名: `lesson6_graph.png`
- 説明: Pythonで表示されたグラフウィンドウ
- 温度、湿度、気圧の3つのサブプロットが表示されている
- 複数のデバイスのデータが異なる色でプロットされている

### 参加者ミッション

AIを使って、3つのグラフを一つのグラフに3つのデータが表示されるコードを作成してください。

**📋 参考プロンプト例**

以下のプロンプトを参考にAIに送信してください。既存のコードとJSONファイルの形式を含めています。

> ```
> pyserialを使ってシリアルポートからJSONデータを読み取り、
> matplotlibでリアルタイムグラフを表示するPythonスクリプトを作成してください。
> 
> 【JSONファイルの形式】
> シリアルポートから以下の形式のJSONが1行ずつ送信されます：
> 
> 1. ゲートウェイ起動時:
> {"type":"gateway_boot","channel":1,"mac":"98:f4:ab:6c:e7:88"}
> 
> 2. センサーデータ（1秒ごと）:
> {"type":"sample","id":"B1","t":25.30,"h":55.20,"p":1013.25,"seq":123,"from":"98:f4:ab:6c:e7:88"}
> 
> 各フィールドの説明:
> - type: "sample"（センサーデータ）または"gateway_boot"（起動メッセージ）
> - id: デバイスID（例: "A1", "B1", "C2"など）
> - t: 温度（°C、float）
> - h: 湿度（%RH、float）
> - p: 気圧（hPa、float）
> - seq: シーケンス番号（uint32）
> - from: 送信元のMACアドレス（文字列）
> 
> 【既存のコード】
> 以下の既存コードを参考にしてください：
> 
> ```python
> # python/lesson6.py
> import argparse
> import json
> import time
> from collections import defaultdict
> from dataclasses import dataclass
> from typing import Dict, List
> 
> import matplotlib.pyplot as plt
> import matplotlib.animation as animation
> import serial
> 
> @dataclass
> class DataPoint:
>     t: float  # 温度
>     h: float  # 湿度
>     p: float  # 気圧
>     timestamp: float  # 受信時刻
> 
> device_data: Dict[str, List[DataPoint]] = defaultdict(list)
> MAX_HISTORY = 100
> 
> fig, axes = plt.subplots(3, 1, figsize=(12, 8))
> axes[0].set_title("Temperature (°C)", fontsize=12)
> axes[1].set_title("Humidity (%)", fontsize=12)
> axes[2].set_title("Pressure (hPa)", fontsize=12)
> 
> def main():
>     parser = argparse.ArgumentParser()
>     parser.add_argument("--port", required=True, help="Windows例: COM5 / macOS例: /dev/tty.usbserial-xxxx")
>     parser.add_argument("--baud", type=int, default=115200)
>     args = parser.parse_args()
>     
>     ser = serial.Serial(args.port, args.baud, timeout=0.2)
>     # ... 以下を実装してください
> ```
> 
> 【要件】
> 1. 複数のデバイス（id）から送信されるデータを時系列グラフで表示
> 2. サブプロットに分けず、1つのAxes（グラフエリア）に全ての線を表示すること。
> 3. 各デバイスごとに異なる色でプロット
> 4. リアルタイムで更新（1秒ごと）
> 5. 過去10分間のデータを表示
> 6. コマンドライン引数でポート番号を指定可能
> 7. 横軸（X軸）は「現在から何分前か」の相対時間（過去10分間分）を表示すること
> 【実装のポイント】
> - pyserialでシリアルポートを開く
> - JSONをパースしてtype="sample"のデータを処理
> - デバイスごとにデータ履歴を保持
> - matplotlib.animationでリアルタイム更新
> - エラーハンドリング（JSONパースエラー、シリアルポートエラーなど）
> ```
>

💡 **使い方**: このプロンプトをAIに送信すると、既存のコードとJSON形式を理解した上で、適切なPythonスクリプトを生成してくれます。

---

## lesson7: 参加者で共同作品

### このレッスンで学ぶこと

各自のM5StickCのチャンネルを一つに合わせて、室内の温度マップを作成します。

### 準備するもの

- M5StickC Plus（各参加者）
- M5Stack（ゲートウェイ用、1台）
- BME280センサー（各参加者）
- USBケーブル

### セットアップ手順

#### パート1: ゲートウェイ（M5Stack）の設定

1. **ファイル > 開く**で`Arduino/gateway_espnow_serial/gateway_espnow_serial.ino`を開く
2. **ツール > ボード**で「**M5Stack**」を選択
3. **コンパイル**して、**アップロード**
4. **シリアルモニター**を開き、**MACアドレス**を確認
5. USBケーブルでPCに接続

#### パート2: 各参加者のM5StickCの設定

1. **ファイル > 開く**で`Arduino/lesson/lesson3.c`を開く
2. **ツール > ボード**で「**M5StickC Plus**」を選択

3. **全員が同じ値**に設定する部分：
   ```c
   // 全員が同じチャンネルに設定
   const int CHANNEL = 1;  // ★講師から指定されたチャンネル番号に変更★
   
   // ゲートウェイのMACアドレス（全員同じ）
   uint8_t GATEWAY_MAC[6] = {0x98, 0xf4, 0xab, 0x6c, 0xe7, 0x88};  // 実際のMACアドレスに変更
   ```
   - `CHANNEL`: 講師から指定された番号に変更
   - `GATEWAY_MAC`: 講師から指定されたMACアドレスに変更（lesson3と同じ方法）

4. **各自の座席番号**に合わせて設定：
   ```c
   // 自分の座席番号に変更
   const char DEVICE_ID[] = "B1";  // ★自分の座席番号に変更★
   ```
   - `"B1"`の部分を自分の座席番号に変更
   - 例: `"A1"`, `"A2"`, `"B2"`, `"C3"`など


4. **コンパイル**して、**アップロード**

## よくあるエラーと解決方法

### エラー1: 「ボードが見つかりません」

**症状**: ボードの選択リストに「M5StickC Plus」や「M5Stack」が表示されない

**解決方法**:
1. ESP32ボードがインストールされているか確認
2. **ツール > ボード > ボードマネージャー**で「ESP32」を検索
3. インストールされていない場合は、[必要な環境の準備](#必要な環境の準備)の手順に従ってインストール

### エラー2: 「シリアルポートが見つかりません」

**症状**: シリアルポートのリストが空、または接続できない

**解決方法**:
1. USBケーブルがデータ転送対応か確認（充電専用ケーブルでは接続できません）
2. USBケーブルを抜き差ししてみる
3. 他のアプリケーションがポートを使用していないか確認
4. デバイスマネージャー（Windows）でポートが認識されているか確認

![[Pasted image 20260114125851.png]]

### エラー3: 「コンパイルエラー: 'M5StickCPlus' was not declared」

**症状**: コンパイル時にライブラリが見つからないエラー

**解決方法**:
1. **ツール > ライブラリを管理**で「M5StickCPlus」を検索
2. インストールされていない場合はインストール
3. インストール後、Arduino IDEを再起動


### エラー4: 「アップロードエラー: Failed to connect to ESP32」

**症状**: アップロード時に接続できない

**解決方法**:
1. USBケーブルが正しく接続されているか確認
2. M5StickC/M5Stackの電源が入っているか確認
3. シリアルポートが正しく選択されているか確認
4. アップロード時にM5StickC/M5Stackのリセットボタンを押してみる


### エラー5: 「BME280が見つかりません」

**症状**: シリアルモニターに「Could not find a valid BME280 sensor」と表示される

**解決方法**:
1. BME280の配線を確認
   - M5StickC Plus: SDA=32番ピン、SCL=33番ピン
2. BME280のI2Cアドレスを確認（デフォルト: 0x76）
3. コード内の`bme.begin(0x76, &Wire);`の`0x76`を`0x77`に変更してみる
**
### エラー6: 「データが受信されない」（lesson3, lesson7）

**症状**: 無線通信がうまくいかない

**解決方法**:
1. ゲートウェイと送信機の`CHANNEL`が一致しているか確認
2. 送信機の`GATEWAY_MAC`が正しいか確認
3. ESP-NOWの通信範囲内にいるか確認（通常10-50m）
4. シリアルモニターでゲートウェイが起動しているか確認


### エラー7: 「Pythonスクリプトがエラーになる」

**症状**: `python lesson6.py`を実行するとエラーが出る

**解決方法**:
1. 必要なライブラリがインストールされているか確認：
   ```bash
   pip install pyserial matplotlib numpy scipy
   ```
2. ポート番号が正しいか確認
3. M5Stackが正しく接続されているか確認
4. 他のアプリケーション（Arduino IDEのシリアルモニターなど）がポートを使用していないか確認

---

## 用語集

### 基本用語

- **Arduino IDE**: マイコンにプログラムを書き込むためのソフトウェア
- **スケッチ**: Arduinoのプログラムファイル
- **コンパイル**: プログラムをマイコンが理解できる形式に変換すること
- **アップロード**: コンパイルしたプログラムをマイコンに書き込むこと
- **シリアルモニター**: マイコンとPCの間でデータをやり取りするための画面
- **ボーレート**: シリアル通信の速度（115200が一般的）

### センサー関連

- **BME280**: 温度・湿度・気圧を測定する環境センサー
- **I2Cアドレス**: I2C通信で使用するセンサーの識別番号（BME280は0x76または0x77）

### 通信方式

- **I2C（アイ・スクエア・シー）**: センサーとマイコンを接続するための有線通信方式。データ線（SDA）とクロック線（SCL）の2本で接続
- **ESP-NOW**: ESP32マイコン専用の無線通信プロトコル。Wi-Fi不要で直接通信可能
- **シリアル通信**: マイコンとPCの間でデータをやり取りする通信方式
- **MACアドレス**: ネットワーク機器に割り当てられる固有の識別番号（ESP-NOWで使用）

### データ形式

- **JSON**: データを表現するための形式。このプロジェクトではセンサーデータをJSON形式で送信

---

## 参考資料

- [M5Stack公式ドキュメント](https://docs.m5stack.com/)
- [ESP-NOW公式ドキュメント](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_now.html)
- [Adafruit BME280 Library](https://github.com/adafruit/Adafruit_BME280_Library)
- [Arduino IDE公式サイト](https://www.arduino.cc/en/software)

---

## 困ったときは

1. エラーメッセージをよく読む
2. [よくあるエラーと解決方法](#よくあるエラーと解決方法)を確認
3. 講師や周りの人に聞く
4. コードのコメントを読む（`//`で始まる行）

**頑張ってください！🎉***