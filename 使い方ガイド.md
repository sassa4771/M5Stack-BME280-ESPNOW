# M5Stack-BME280-ESPNOW 使い方ガイド

このガイドでは、lesson1からlesson7までの学習用コードの使い方を説明します。

## 目次

1. [必要な環境](#必要な環境)
2. [lesson1: センサーを使う](#lesson1-センサーを使う)
3. [lesson2: マイコンのUI作成](#lesson2-マイコンのui作成)
4. [lesson3: 無線通信をする（ESP-NOW）](#lesson3-無線通信をするesp-now)
5. [lesson4: マイコンのUI作成（M5Stack側）](#lesson4-マイコンのui作成m5stack側)
6. [lesson5: PCとの接続（Python）](#lesson5-pcとの接続python)
7. [lesson6: PythonでUIを作成](#lesson6-pythonでuiを作成)
8. [lesson7: 参加者で共同作品](#lesson7-参加者で共同作品)

---

## 必要な環境

### ハードウェア
- **M5StickC Plus**（lesson1-3, lesson7用）
- **M5Stack**（lesson4-5用）
- **BME280センサー**（I2C接続）

### ソフトウェア
- **Arduino IDE**（バージョン1.8以上推奨）
- **Python 3.7以上**（lesson5-7用）
- **必要なPythonライブラリ**:
  ```bash
  pip install pyserial matplotlib numpy scipy
  ```

### Arduino IDEの設定
1. **ボードマネージャー**でESP32をインストール（バージョン2.0.1推奨）
2. **ライブラリマネージャー**で以下をインストール:
   - M5StickCPlus（M5StickC Plus用）
   - M5Stack（M5Stack用）
   - Adafruit BME280 Library
   - Adafruit Unified Sensor

---

## lesson1: センサーを使う

### 概要
M5StickCとBME280を使って温度・湿度・気圧を計測し、画面に表示します。

### ファイル
- `Arduino/lesson/lesson1.c`

### セットアップ手順
1. Arduino IDEで`lesson1.c`を開く
2. **ツール > ボード**で「M5StickC Plus」を選択
3. **ツール > シリアルポート**で適切なポートを選択
4. コンパイル・アップロード

### 動作確認
- M5StickCの画面に温度・湿度・気圧が表示されます
- 1秒ごとに更新されます

### 参加者ミッション
自分の割り当てられた番号もモニターに表示できるように変更してください。

---

## lesson2: マイコンのUI作成

### 概要
lesson1をベースに、BME280から取得したデータをグラフ描画します。

### ファイル
- `Arduino/lesson/lesson2.c`

### セットアップ手順
1. Arduino IDEで`lesson2.c`を開く
2. **ツール > ボード**で「M5StickC Plus」を選択
3. コンパイル・アップロード

### 動作確認
- 温度のグラフが表示されます
- グラフは過去20データポイントを表示します

### 参加者ミッション
最初は温度のグラフが表示されます。気圧や湿度のグラフを表示できるように変更してください。

**ヒント**: `loop()`関数内の`drawGraph(temp)`の部分を変更します。
- 気圧のグラフ: `drawGraph(pres);`
- 湿度のグラフ: `drawGraph(hum);`

---

## lesson3: 無線通信をする（ESP-NOW）

### 概要
M5StickCからM5StackにBME280のデータをESP-NOWで無線通信します。

### ファイル
- `Arduino/lesson/lesson3.c`（送信側：M5StickC）
- `Arduino/gateway_espnow_serial/gateway_espnow_serial.ino`（受信側：M5Stack）

### セットアップ手順

#### 1. ゲートウェイ（受信側）の設定
1. Arduino IDEで`gateway_espnow_serial.ino`を開く
2. **ツール > ボード**で「M5Stack」を選択
3. `CHANNEL`を確認（デフォルト: 1）
4. コンパイル・アップロード
5. シリアルモニター（115200 baud）を開き、**MACアドレスを確認**（例: `98:f4:ab:6c:e7:88`）

#### 2. 送信側（M5StickC）の設定
1. Arduino IDEで`lesson3.c`を開く
2. **ツール > ボード**で「M5StickC Plus」を選択
3. 以下の設定を変更:
   ```c
   // ゲートウェイのMACアドレスを設定
   uint8_t GATEWAY_MAC[6] = {0x98, 0xf4, 0xab, 0x6c, 0xe7, 0x88};  // 実際のMACアドレスに変更
   
   // デバイスIDを設定
   const char DEVICE_ID[] = "B1";  // 自分のIDに変更
   
   // チャンネルをゲートウェイと同じに設定
   const int CHANNEL = 1;  // ゲートウェイと同じチャンネル
   ```
4. コンパイル・アップロード

### 動作確認
- M5StickCの画面に「ESP-NOW Sender」と表示され、送信状態が表示されます
- M5StackのシリアルモニターにJSON形式のデータが表示されます

### 参加者ミッション
ESP-NOWの無線通信部分がどこにあるか学習してください。特に以下の部分を確認:
- `esp_now_init()`: ESP-NOWの初期化
- `esp_now_send()`: データの送信
- `OnDataSent()`: 送信完了コールバック

---

## lesson4: マイコンのUI作成（M5Stack側）

### 概要
M5Stack側でESP-NOWで受信したデータをグラフ表示します。

### ファイル
- `Arduino/lesson/lesson4.c`（M5Stack側）
- `Arduino/lesson/lesson3.c`（M5StickC側：送信側）

### セットアップ手順
1. lesson3と同様に、送信側（M5StickC）と受信側（M5Stack）を設定
2. `lesson4.c`をM5Stackにアップロード
3. `lesson3.c`をM5StickCにアップロード

### 動作確認
- M5Stackの画面に温度のグラフが表示されます
- 受信したデータ数や最後に受信したデバイスIDが表示されます

### 参加者ミッション
最初は温度だけのグラフが表示されます。気圧も湿度も一緒に表示できるように変更してください。

**ヒント**: `loop()`関数内のグラフ描画部分を変更します。
```c
// 温度のグラフ
drawGraphWithLabel(tempHistory, RED, "Temp:", graphYOffset);
graphYOffset += GRAPH_HEIGHT + 20;

// 湿度のグラフを追加
drawGraphWithLabel(humHistory, BLUE, "Humidity:", graphYOffset);
graphYOffset += GRAPH_HEIGHT + 20;

// 気圧のグラフを追加
drawGraphWithLabel(presHistory, GREEN, "Pressure:", graphYOffset);
graphYOffset += GRAPH_HEIGHT + 20;
```

---

## lesson5: PCとの接続（Python）

### 概要
M5StackからPythonにシリアル通信でデータを取得します。

### ファイル
- `Arduino/lesson/lesson5.c`（M5Stack側）
- `Arduino/lesson/lesson3.c`（M5StickC側：送信側）

### セットアップ手順
1. lesson3と同様に、送信側（M5StickC）と受信側（M5Stack）を設定
2. `lesson5.c`をM5Stackにアップロード
3. M5StackをUSBケーブルでPCに接続
4. シリアルポート番号を確認（Windows: COM5など、macOS: /dev/tty.usbserial-xxxxなど）

### Pythonでのデータ取得
シリアルモニターを開くと、以下のようなJSON形式のデータが表示されます:
```json
{"type":"sample","id":"B1","t":25.30,"h":55.20,"p":1013.25,"seq":123,"from":"98:f4:ab:6c:e7:88"}
```

### 参加者ミッション
シリアル通信について学んでください。COMポートの設定が人によって違うことを学習します。

**確認ポイント**:
- WindowsとmacOS/Linuxでポート名の形式が異なる
- ボーレート（115200）が一致している必要がある
- 他のアプリケーションがポートを使用していないか確認

---

## lesson6: PythonでUIを作成

### 概要
シリアル通信で取得したデータをPythonでグラフ化します。

### ファイル
- `python/lesson6.py`
- `Arduino/lesson/lesson5.c`（M5Stack側）

### セットアップ手順
1. lesson5と同様に、M5StackをPCに接続
2. Pythonスクリプトを実行:
   ```bash
   cd python
   python lesson6.py --port COM5  # Windowsの場合
   # または
   python lesson6.py --port /dev/tty.usbserial-xxxx  # macOS/Linuxの場合
   ```

### 動作確認
- Pythonのウィンドウにグラフが表示されます
- リアルタイムでデータが更新されます

### 参加者ミッション
AIを使って、シリアル通信をPythonでグラフ化するコードを作成してください。

**📋 参考プロンプト例**

以下のプロンプトをAIに送信してください。既存のコードとJSONファイルの形式を含めています。

> ```
> pyserialを使ってシリアルポートからJSONデータを読み取り、
> matplotlibでリアルタイムグラフを表示するPythonスクリプトを作成してください。
> 
> 【JSONファイルの形式】
> シリアルポートから以下の形式のJSONが1行ずつ送信されます：
> 
> 1. ゲートウェイ起動時:
> {"type":"gateway_boot","channel":1,"mac":"98:f4:ab:6c:e7:88"}
> 
> 2. センサーデータ（1秒ごと）:
> {"type":"sample","id":"B1","t":25.30,"h":55.20,"p":1013.25,"seq":123,"from":"98:f4:ab:6c:e7:88"}
> 
> 各フィールドの説明:
> - type: "sample"（センサーデータ）または"gateway_boot"（起動メッセージ）
> - id: デバイスID（例: "A1", "B1", "C2"など）
> - t: 温度（°C、float）
> - h: 湿度（%RH、float）
> - p: 気圧（hPa、float）
> - seq: シーケンス番号（uint32）
> - from: 送信元のMACアドレス（文字列）
> 
> 【既存のコード】
> 以下の既存コードを参考にしてください：
> 
> ```python
> # python/lesson6.py
> import argparse
> import json
> import time
> from collections import defaultdict
> from dataclasses import dataclass
> from typing import Dict, List
> 
> import matplotlib.pyplot as plt
> import matplotlib.animation as animation
> import serial
> 
> @dataclass
> class DataPoint:
>     t: float  # 温度
>     h: float  # 湿度
>     p: float  # 気圧
>     timestamp: float  # 受信時刻
> 
> device_data: Dict[str, List[DataPoint]] = defaultdict(list)
> MAX_HISTORY = 100
> 
> fig, axes = plt.subplots(3, 1, figsize=(12, 8))
> axes[0].set_title("Temperature (°C)", fontsize=12)
> axes[1].set_title("Humidity (%)", fontsize=12)
> axes[2].set_title("Pressure (hPa)", fontsize=12)
> 
> def main():
>     parser = argparse.ArgumentParser()
>     parser.add_argument("--port", required=True, help="Windows例: COM5 / macOS例: /dev/tty.usbserial-xxxx")
>     parser.add_argument("--baud", type=int, default=115200)
>     args = parser.parse_args()
>     
>     ser = serial.Serial(args.port, args.baud, timeout=0.2)
>     # ... 以下を実装してください
> ```
> 
> 【要件】
> 1. 複数のデバイス（id）から送信されるデータを時系列グラフで表示
> 2. 温度、湿度、気圧の3つのサブプロットを表示
> 3. 各デバイスごとに異なる色でプロット
> 4. リアルタイムで更新（1秒ごと）
> 5. 過去10分間のデータを表示
> 6. コマンドライン引数でポート番号を指定可能
> 
> 【実装のポイント】
> - pyserialでシリアルポートを開く
> - JSONをパースしてtype="sample"のデータを処理
> - デバイスごとにデータ履歴を保持
> - matplotlib.animationでリアルタイム更新
> - エラーハンドリング（JSONパースエラー、シリアルポートエラーなど）
> ```


💡 **使い方**: このプロンプトをAIに送信すると、既存のコードとJSON形式を理解した上で、適切なPythonスクリプトを生成してくれます。

---

## lesson7: 参加者で共同作品

### 概要
各自のM5StickCのチャンネルを一つに合わせて、室内の温度マップを作成します。

### ファイル
- `Arduino/lesson/lesson7.c`（送信側：M5StickC）
- `Arduino/gateway_espnow_serial/gateway_espnow_serial.ino`（受信側：M5Stack）
- `python/pc_viewer_2dmap_interpolated.py`（PC側：可視化ツール）

### セットアップ手順

#### 1. ゲートウェイ（M5Stack）の設定
1. `gateway_espnow_serial.ino`をM5Stackにアップロード
2. シリアルモニターでMACアドレスを確認
3. USBケーブルでPCに接続

#### 2. 各参加者のM5StickCの設定
1. `lesson7.c`を開く
2. 以下の設定を**全員が同じ値**に設定:
   ```c
   // 全員が同じチャンネルに設定
   const int CHANNEL = 1;  // ★講師から指定されたチャンネル番号に変更★
   
   // ゲートウェイのMACアドレス（全員同じ）
   uint8_t GATEWAY_MAC[6] = {0x98, 0xf4, 0xab, 0x6c, 0xe7, 0x88};  // 実際のMACアドレスに変更
   ```
3. 各自の座席番号に合わせて設定:
   ```c
   // 自分の座席番号に変更
   const char DEVICE_ID[] = "B1";  // ★自分の座席番号に変更★
   // 例: "A1", "A2", "A3", "A4", "B1", "B2", "B3", "B4", "C1", "C2", "C3", "C4", "D1", "D2", "D3", "D4"
   ```
4. コンパイル・アップロード

#### 3. PC側の可視化ツールの起動
```bash
cd python
python pc_viewer_2dmap_interpolated.py --port COM5 --metric t  # 温度マップ
# または
python pc_viewer_2dmap_interpolated.py --port COM5 --metric h  # 湿度マップ
python pc_viewer_2dmap_interpolated.py --port COM5 --metric p  # 気圧マップ
```

### 動作確認
- PCの画面に4x4グリッド（16座席）の2Dマップが表示されます
- 各座席のデータが色で表現されます
- データが来ていない座席は赤色で表示されます

### 参加者ミッション
今まで使ったM5StickCのプログラムを少し変更してもらって、共同作品を作成してください。

**変更例**:
- `displayMetric`変数を変更して、気圧や湿度のグラフを表示
- 送信間隔を変更（`SEND_INTERVAL_MS`）

---

## トラブルシューティング

### データが受信されない（lesson3, lesson7）
1. ゲートウェイと送信機の`CHANNEL`が一致しているか確認
2. 送信機の`GATEWAY_MAC`が正しいか確認
3. ESP-NOWの通信範囲内にいるか確認（通常10-50m）
4. シリアルモニターでゲートウェイが起動しているか確認

### BME280が見つからない（lesson1-3, lesson7）
1. I2C接続を確認（M5StickC Plus: SDA=32, SCL=33）
2. BME280のI2Cアドレスを確認（デフォルト: 0x76）
3. 配線を確認

### シリアルポートが見つからない（lesson5-7）
1. デバイスマネージャー（Windows）または`ls /dev/tty.*`（macOS/Linux）でポートを確認
2. 他のアプリケーションがポートを使用していないか確認
3. USBケーブルがデータ転送対応か確認

### Pythonスクリプトがエラーになる（lesson6-7）
1. 必要なライブラリがインストールされているか確認:
   ```bash
   pip install pyserial matplotlib numpy scipy
   ```
2. ポート番号が正しいか確認
3. M5Stackが正しく接続されているか確認

---

## 参考資料

- [M5Stack公式ドキュメント](https://docs.m5stack.com/)
- [ESP-NOW公式ドキュメント](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_now.html)
- [Adafruit BME280 Library](https://github.com/adafruit/Adafruit_BME280_Library)

---

## コードの変更履歴

各lessonファイルには、前のlessonからどこを追加・削除したかがコメントで記載されています。
- `==== lessonX で追加 ====`: lessonXで追加されたコード
- `==== lessonX で変更 ====`: lessonXで変更されたコード
- `==== lessonX で削除 ====`: lessonXで削除されたコード

これらのコメントを参考に、コードの流れを理解してください。
